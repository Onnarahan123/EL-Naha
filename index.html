<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elektrihind LIVE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --accent: #3b82f6;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; 
            color: var(--text-main);
        }
        .app-container { 
            max-width: 500px; width: 100%; 
            background: var(--card-bg); 
            padding: 24px; border-radius: 30px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05); 
            margin-top: 20px; box-sizing: border-box;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 1.2rem; font-weight: 800; margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .price-card { 
            padding: 40px 20px; border-radius: 24px; 
            margin-bottom: 25px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .price-label { font-size: 0.9rem; font-weight: 600; opacity: 0.8; margin-bottom: 5px; }
        .price-value { font-size: 4.5rem; font-weight: 800; margin: 0; line-height: 1; }
        .price-unit { font-size: 1.2rem; font-weight: 600; }
        
        .status-badge { 
            display: inline-block; padding: 6px 16px; border-radius: 100px; 
            background: rgba(255,255,255,0.2); font-weight: 700; font-size: 0.8rem; margin-top: 15px;
        }

        /* Värviteemad */
        .theme-cheap { background: #22c55e; color: white; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3); }
        .theme-normal { background: #eab308; color: white; box-shadow: 0 10px 20px rgba(234, 179, 8, 0.3); }
        .theme-expensive { background: #ef4444; color: white; box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3); }

        .chart-section { width: 100%; height: 250px; margin-top: 10px; }
        .footer-info { font-size: 0.75rem; color: #94a3b8; margin-top: 20px; text-align: center; line-height: 1.5; }
        
        #loader { font-weight: 600; color: #64748b; padding: 100px 0; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>Elektrihind</h1>
        <div id="clock" style="font-weight: 600; color: #64748b;">00:00</div>
    </div>

    <div id="loader">Uuendan börsiinfot...</div>

    <div id="main-content" style="display:none;">
        <div id="price-box" class="price-card">
            <div class="price-label">Hetkel</div>
            <div class="price-value"><span id="val">0.00</span><span class="price-unit">s/kWh</span></div>
            <div id="badge" class="status-badge">KONTROLLIN...</div>
        </div>

        <div class="chart-section">
            <canvas id="liveChart"></canvas>
        </div>
    </div>

    <div class="footer-info">
        Uuendatud: <span id="update-time">-</span><br>
        Hinnad sisaldavad KM 22%
    </div>
</div>

<script>
    let myChart;

    // Kellafunktsioon
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('et-EE', {hour: '2-digit', minute:'2-digit'});
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function getElectricityData() {
        try {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2).toISOString();
            
            const apiUrl = `https://dashboard.elering.ee/api/nps/price?start=${start}&end=${end}`;
            const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`);
            const wrapper = await response.json();
            const json = JSON.parse(wrapper.contents);
            const data = json.data.ee;

            processData(data);
        } catch (e) {
            document.getElementById('loader').innerText = "Viga andmetega. Proovi uuesti.";
        }
    }

    function processData(eeData) {
        const now = new Date();
        const currentHourStart = new Date().setMinutes(0,0,0);
        
        const labels = [];
        const prices = [];
        let currentPrice = 0;

        eeData.forEach(item => {
            const itemDate = new Date(item.timestamp * 1000);
            const hour = itemDate.getHours();
            const isTomorrow = itemDate.getDate() !== now.getDate();
            
            labels.push(`${isTomorrow ? 'H ' : ''}${hour}:00`);
            const p = (item.price / 10 * 1.22).toFixed(2);
            prices.push(parseFloat(p));

            if (item.timestamp * 1000 === currentHourStart) {
                currentPrice = p;
            }
        });

        updateUI(currentPrice, labels, prices);
    }

    function updateUI(price, labels, prices) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('val').innerText = price;
        document.getElementById('update-time').innerText = new Date().toLocaleTimeString('et-EE');

        const box = document.getElementById('price-box');
        const badge = document.getElementById('badge');
        const p = parseFloat(price);

        if (p < 10) {
            box.className = 'price-card theme-cheap';
            badge.innerText = "ODAV AEG ✅";
        } else if (p < 20) {
            box.className = 'price-card theme-normal';
            badge.innerText = "TAVALINE HIND ⚖️";
        } else {
            box.className = 'price-card theme-expensive';
            badge.innerText = "KALLIS! ❌";
        }

        renderChart(labels, prices);
    }

    function renderChart(labels, prices) {
        const ctx = document.getElementById('liveChart').getContext('2d');
        if (myChart) myChart.destroy();

        const currentHour = new Date().getHours();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: prices,
                    borderColor: '#3b82f6',
                    borderWidth: 4,
                    pointRadius: (ctx) => ctx.dataIndex === currentHour ? 6 : 0,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: '#3b82f6',
                    pointBorderWidth: 3,
                    fill: true,
                    backgroundColor: (context) => {
                        const chart = context.chart;
                        const {ctx, chartArea} = chart;
                        if (!chartArea) return null;
                        const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                        return gradient;
                    },
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { size: 10 }, maxTicksLimit: 8 }
                    },
                    y: {
                        grid: { color: '#f1f5f9' },
                        ticks: { color: '#94a3b8', font: { size: 10 } }
                    }
                }
            }
        });
    }

    getElectricityData();
    // Värskenda iga 15 minuti järel
    setInterval(getElectricityData, 15 * 60 * 1000);
</script>

</body>
</html>
