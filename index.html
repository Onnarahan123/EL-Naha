<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutikas Elektrihind</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/wind-turbine.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-muted: #757575;
            --danger: #e53935;
            --warning: #fb8c00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 500px; padding-bottom: 60px; }

        /* KAARDID */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        h2 { font-size: 14px; text-transform: uppercase; color: var(--text-muted); margin: 0 0 10px 0; letter-spacing: 0.5px; }

        /* HETKEHIND */
        .hero-section { text-align: center; }
        .hero-price { font-size: 64px; font-weight: 800; color: var(--primary-green); line-height: 1; }
        .hero-unit { font-size: 18px; color: var(--text-muted); font-weight: 500; }
        .hero-time { font-size: 14px; background: #e8f5e9; color: var(--dark-green); padding: 4px 12px; border-radius: 12px; display: inline-block; margin-bottom: 10px; font-weight: 600; }

        /* V√ïRDLUS (T√ÑNA VS HOMME) */
        .comparison-grid { display: flex; gap: 10px; margin-top: 10px; }
        .comp-box { flex: 1; background: #fafafa; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .comp-val { font-size: 20px; font-weight: 700; display: block; }
        .comp-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
        .diff-badge { font-size: 12px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-top: 5px; display: inline-block; }
        .diff-up { background: #ffebee; color: var(--danger); }
        .diff-down { background: #e8f5e9; color: var(--dark-green); }

        /* GRAAFIK */
        .chart-container { position: relative; height: 320px; width: 100%; }
        
        /* TOP 3 LISTID */
        .hours-grid { display: flex; gap: 15px; }
        .hours-col { flex: 1; }
        .hours-list { list-style: none; padding: 0; margin: 0; }
        .hours-list li { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .hours-list li:last-child { border-bottom: none; }
        .h-time { color: var(--text-muted); }
        .h-price { font-weight: 600; }
        .col-title { font-size: 12px; font-weight: 700; margin-bottom: 8px; display: block; }
        .good { color: var(--dark-green); }
        .bad { color: var(--danger); }

        /* ILM JA INFO */
        .context-row { display: flex; align-items: center; gap: 10px; font-size: 14px; margin-bottom: 8px; }
        .context-icon { font-size: 20px; width: 30px; text-align: center; }
        
        /* SEADED / TEAVITUSED */
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .toggle-btn { background: #eee; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .toggle-btn.active { background: var(--primary-green); color: white; }

        /* Footer */
        .footer { text-align: center; font-size: 11px; color: #aaa; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">

    <div class="card hero-section">
        <div id="current-time" class="hero-time">--:--</div>
        <div id="current-price" class="hero-price">--</div>
        <div class="hero-unit">senti / kWh (KM 24%)</div>
        
        <div class="comparison-grid">
            <div class="comp-box">
                <span class="comp-label">T√§na keskmine</span>
                <span id="avg-today" class="comp-val">--</span>
            </div>
            <div class="comp-box">
                <span class="comp-label">Homme keskmine</span>
                <span id="avg-tomorrow" class="comp-val">--</span>
                <span id="diff-badge" class="diff-badge" style="display:none;">--%</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>Hinnagraafik</h2>
            <select id="day-select" onchange="renderChart()" style="border:none; bg:transparent; font-weight:600; color:#4CAF50;">
                <option value="today">T√§na</option>
                <option value="tomorrow">Homme</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>Parimad ja Halvimad ajad</h2>
        <div class="hours-grid">
            <div class="hours-col">
                <span class="col-title good">üü¢ Soodsamad 3h</span>
                <ul class="hours-list" id="list-cheap">Loading...</ul>
            </div>
            <div class="hours-col">
                <span class="col-title bad">üî¥ Kalleimad 3h</span>
                <ul class="hours-list" id="list-expensive">Loading...</ul>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Ilm ja Seosed</h2>
        <div id="weather-context">
            Laen andmeid...
        </div>
    </div>

    <div class="card">
        <h2>Teavitused</h2>
        <p style="font-size:13px; color:#666; margin:0;">Saada teade, kui hind on alla 5 sendi v√µi kui homme on kallis.</p>
        <div class="settings-row">
            <span style="font-size:14px; font-weight:600;">Luba teavitused</span>
            <button id="btn-notify" class="toggle-btn" onclick="toggleNotifications()">Luba</button>
        </div>
    </div>

    <div class="footer">Made by Ranno ‚Ä¢ Andmed: Elering & Open-Meteo</div>

</div>

<script>
    // --- KONFIGURATSIOON ---
    const KM = 1.24; // 24% K√§ibemaks
    const NOTIFY_THRESH_LOW = 5.0; // Alla selle hinna saada teade
    let electricityData = { today: [], tomorrow: [] };
    let weatherData = {};
    let chartInstance = null;
    let notificationsEnabled = false;

    // --- ALUSTUS ---
    document.addEventListener("DOMContentLoaded", () => {
        initApp();
        // Kontrolli, kas teavitused on juba lubatud
        if (Notification.permission === "granted") {
            notificationsEnabled = true;
            updateNotifyButton();
        }
    });

    async function initApp() {
        await Promise.all([fetchElectricity(), fetchWeather()]);
        processData();
        renderChart();
        updateUI();
        checkNotifications(); // Kontrolli, kas on vaja teavitada
    }

    // --- 1. ANDMETE P√ÑRIMINE ---
    async function fetchElectricity() {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2).toISOString();
        
        // Kasutame proxyt CORS v√§ltimiseks
        const url = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://dashboard.elering.ee/api/nps/price?start=${start}&end=${end}`)}`;
        
        try {
            const resp = await fetch(url);
            const json = await resp.json();
            const data = json.data.ee;

            // Jagame andmed t√§naseks ja homseks
            const todayStr = new Date().toDateString();
            const tomorrowStr = new Date(new Date().setDate(new Date().getDate() + 1)).toDateString();

            electricityData.today = data.filter(d => new Date(d.timestamp * 1000).toDateString() === todayStr);
            electricityData.tomorrow = data.filter(d => new Date(d.timestamp * 1000).toDateString() === tomorrowStr);
        } catch (e) {
            console.error("Elekter fail:", e);
        }
    }

    async function fetchWeather() {
        // V√µru koordinaadid
        const lat = 57.848; const lon = 27.014;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m&daily=temperature_2m_min,wind_speed_10m_max&timezone=auto`;

        try {
            const resp = await fetch(url);
            weatherData = await resp.json();
        } catch (e) { console.error("Ilm fail:", e); }
    }

    // --- 2. UI UUENDAMINE ---
    function updateUI() {
        // Hetkehind
        const currentTs = Math.floor(Date.now() / 1000 / 3600) * 3600;
        const currentItem = electricityData.today.find(d => d.timestamp === currentTs);
        
        if (currentItem) {
            const price = (currentItem.price / 10 * KM).toFixed(2);
            document.getElementById('current-price').innerText = price;
            
            // Kellaaeg (nt 14:00 - 15:00)
            const date = new Date(currentItem.timestamp * 1000);
            const h = date.getHours().toString().padStart(2,'0');
            const hNext = (date.getHours() + 1).toString().padStart(2,'0');
            document.getElementById('current-time').innerText = `${h}:00 ‚Äì ${hNext}:00`;
        }

        // Keskmised
        const avgToday = calculateAvg(electricityData.today);
        document.getElementById('avg-today').innerText = avgToday;

        if (electricityData.tomorrow.length > 0) {
            const avgTom = calculateAvg(electricityData.tomorrow);
            document.getElementById('avg-tomorrow').innerText = avgTom;
            
            // Erinevus %
            const diff = ((avgTom - avgToday) / avgToday) * 100;
            const badge = document.getElementById('diff-badge');
            badge.style.display = 'inline-block';
            badge.innerText = (diff > 0 ? "+" : "") + diff.toFixed(0) + "%";
            badge.className = diff > 0 ? "diff-badge diff-up" : "diff-badge diff-down";
        } else {
            document.getElementById('avg-tomorrow').innerText = "-";
            document.getElementById('avg-tomorrow').style.fontSize = "14px";
            document.getElementById('avg-tomorrow').innerText = "Pole veel";
        }

        // Top 3 nimekirjad (kuvame valitud p√§eva omasid, vaikimisi t√§na)
        updateTopLists(electricityData.today);

        // Ilma seosed
        updateWeatherContext();
    }

    function calculateAvg(data) {
        if (!data.length) return 0;
        const sum = data.reduce((acc, item) => acc + (item.price / 10 * KM), 0);
        return (sum / data.length).toFixed(2);
    }

    function updateTopLists(data) {
        if (!data.length) return;
        
        // Teeme koopia ja sordime
        const sorted = [...data].sort((a, b) => a.price - b.price);
        const cheapest = sorted.slice(0, 3);
        const expensive = sorted.slice(-3).reverse();

        const renderList = (items, elId) => {
            const el = document.getElementById(elId);
            el.innerHTML = items.map(item => {
                const date = new Date(item.timestamp * 1000);
                const h = date.getHours().toString().padStart(2,'0');
                const hEnd = (date.getHours() + 1).toString().padStart(2,'0');
                const p = (item.price / 10 * KM).toFixed(1);
                return `<li><span class="h-time">${h}:00‚Äì${hEnd}</span> <span class="h-price">${p} s</span></li>`;
            }).join('');
        };

        renderList(cheapest, 'list-cheap');
        renderList(expensive, 'list-expensive');
    }

    function updateWeatherContext() {
        if (!weatherData.current) return;
        
        const temp = weatherData.current.temperature_2m;
        const wind = weatherData.current.wind_speed_10m;
        const div = document.getElementById('weather-context');
        
        let html = `
            <div class="context-row">
                <span class="context-icon">üå°Ô∏è</span>
                <span>Temperatuur hetkel <b>${temp}¬∞C</b>.</span>
            </div>
            <div class="context-row">
                <span class="context-icon">üå¨Ô∏è</span>
                <span>Tuule kiirus <b>${wind} km/h</b>.</span>
            </div>
        `;

        // Nutikas anal√º√ºs
        let insights = [];
        if (wind > 20) insights.push("üå™ Tugev tuul ‚Äì see surub tavaliselt hinda alla!");
        if (temp < -10) insights.push("‚ùÑÔ∏è V√§ga k√ºlm ‚Äì oodata on tarbimise kasvu ja k√µrgemat hinda.");
        if (temp > -5 && wind > 15) insights.push("‚úÖ Hea tuuleenergia toodang hoiab hinna kontrolli all.");

        if (insights.length > 0) {
            html += `<div style="margin-top:10px; padding:10px; background:#e3f2fd; border-radius:8px; font-size:13px; color:#0d47a1;">${insights.join('<br>')}</div>`;
        }

        div.innerHTML = html;
    }

    // --- 3. GRAAFIK (CHART.JS) ---
    function renderChart() {
        const ctx = document.getElementById('priceChart').getContext('2d');
        const selection = document.getElementById('day-select').value;
        const dataset = selection === 'today' ? electricityData.today : electricityData.tomorrow;

        if (!dataset || dataset.length === 0) {
            // Kui andmeid pole (nt homme)
            if (chartInstance) chartInstance.destroy();
            return; 
        }

        // Uuenda top liste ka valiku p√µhjal
        updateTopLists(dataset);

        const labels = dataset.map(d => new Date(d.timestamp * 1000).getHours());
        const prices = dataset.map(d => parseFloat((d.price / 10 * KM).toFixed(2)));
        const dayAvg = parseFloat(calculateAvg(dataset));

        // V√§rviloogika (Segment)
        const getSegmentColor = (ctx) => {
            const p = ctx.p0.parsed.y;
            if (p < 10) return '#4CAF50'; // Roheline
            if (p < 25) return '#FFC107'; // Kollane
            return '#F44336'; // Punane
        };

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hind',
                    data: prices,
                    borderWidth: 3,
                    stepped: true, // TEKITAB ASTMELISE JOONE
                    fill: false,
                    segment: {
                        borderColor: ctx => getSegmentColor(ctx)
                    },
                    pointRadius: 0, // Peida punktid vaikimisi
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#333'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    annotation: {
                        annotations: {
                            avgLine: {
                                type: 'line',
                                yMin: dayAvg,
                                yMax: dayAvg,
                                borderColor: 'rgba(0,0,0,0.3)',
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    display: true,
                                    content: `Keskmine: ${dayAvg}`,
                                    position: 'start',
                                    backgroundColor: 'rgba(255,255,255,0.8)',
                                    color: '#666',
                                    font: { size: 10 }
                                }
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255,255,255,0.95)',
                        titleColor: '#000',
                        bodyColor: '#000',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            title: (ctx) => {
                                const h = ctx[0].label.toString().padStart(2,'0');
                                const hNext = (parseInt(ctx[0].label) + 1).toString().padStart(2,'0');
                                return `${h}:00 ‚Äì ${hNext}:00`;
                            },
                            label: (ctx) => {
                                const price = ctx.raw;
                                const diff = ((price - dayAvg) / dayAvg * 100).toFixed(0);
                                const sign = diff > 0 ? "+" : "";
                                return [`Hind: ${price} s/kWh`, `Erinevus keskmisest: ${sign}${diff}%`];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { 
                            // N√§ita k√µiki kellaaegu, kui ruumi on, v√µi iga teist
                            maxTicksLimit: 13, 
                            callback: function(val, index) {
                                // N√§ita 0, 2, 4... v√µi kui ruumi on, siis 12, 13, 14
                                return this.getLabelForValue(val);
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f0f0f0' }
                    }
                }
            }
        });
    }

    // --- 4. TEAVITUSED (NOTIFICATIONS) ---
    function toggleNotifications() {
        if (!("Notification" in window)) {
            alert("Sinu brauser ei toeta teavitusi.");
            return;
        }

        if (Notification.permission === "granted") {
            // Kasutaja tahab v√§lja l√ºlitada (lihtsustatud loogika: me ei saa luba 'tagasi v√µtta', aga saame lipu maha v√µtta)
            notificationsEnabled = !notificationsEnabled;
            updateNotifyButton();
        } else {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationsEnabled = true;
                    new Notification("Teavitused lubatud!", { body: "Anname m√§rku, kui hind on odav." });
                    updateNotifyButton();
                    checkNotifications();
                }
            });
        }
    }

    function updateNotifyButton() {
        const btn = document.getElementById('btn-notify');
        if (notificationsEnabled) {
            btn.innerText = "Lubatud ‚úÖ";
            btn.classList.add('active');
        } else {
            btn.innerText = "Luba";
            btn.classList.remove('active');
        }
    }

    function checkNotifications() {
        if (!notificationsEnabled) return;
        
        // 1. Kas praegu on odav?
        const currentPriceEl = document.getElementById('current-price');
        const price = parseFloat(currentPriceEl.innerText);
        
        // Kasutame localStorage'it, et mitte spammida iga kord kui √§pp avatakse
        const lastAlertTime = localStorage.getItem('last_cheap_alert');
        const now = Date.now();

        // Kui hind on alla piiri ja pole viimase 6h jooksul teavitanud
        if (price < NOTIFY_THRESH_LOW && (!lastAlertTime || now - lastAlertTime > 6 * 60 * 60 * 1000)) {
            new Notification("Super hind!", { 
                body: `Elekter on praegu vaid ${price} s/kWh. Pane masinad t√∂√∂le!`,
                icon: "https://img.icons8.com/color/96/lightning-bolt.png"
            });
            localStorage.setItem('last_cheap_alert', now);
        }

        // 2. Homne hind (kui andmed olemas)
        const avgTomEl = document.getElementById('avg-tomorrow');
        if (avgTomEl.innerText !== "-" && avgTomEl.innerText !== "Pole veel") {
            const avgTom = parseFloat(avgTomEl.innerText);
            const avgToday = parseFloat(document.getElementById('avg-today').innerText);
            const lastTomAlert = localStorage.getItem('last_tomorrow_alert');
            
            // Kui homme on 20% kallim kui t√§na
            if (avgTom > avgToday * 1.2 && (!lastTomAlert || now - lastTomAlert > 12 * 60 * 60 * 1000)) {
                new Notification("Hoiatus homseks", {
                    body: `Homme on keskmine hind ${avgTom} s/kWh (kallim kui t√§na).`,
                });
                localStorage.setItem('last_tomorrow_alert', now);
            }
        }
    }
</script>

</body>
</html>
