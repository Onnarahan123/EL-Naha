<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutikas Elekter v6</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/wind-turbine.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        /* --- TEEMAD (LIGHT / DARK) --- */
        :root {
            --primary: #4CAF50;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #1d1d1f;
            --muted: #86868b;
            --danger: #FF3B30;
            --border: rgba(0,0,0,0.05);
            --modal-bg: rgba(255,255,255,0.95);
            --chart-grid: #f0f0f0;
        }

        [data-theme="dark"] {
            --bg: #000000;
            --card: #1c1c1e;
            --text: #f5f5f7;
            --muted: #a1a1a6;
            --border: rgba(255,255,255,0.1);
            --modal-bg: #1c1c1e;
            --chart-grid: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { width: 100%; max-width: 500px; padding-bottom: 80px; }

        /* HEADER & SETTINGS */
        .app-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 15px; }
        .app-title { font-weight: 800; font-size: 20px; color: var(--primary); }
        .settings-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text); }

        /* CARD */
        .card {
            background: var(--card);
            border-radius: 22px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden; 
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }

        /* LIVE EFEKTID */
        .effect-aurora {
            background: linear-gradient(120deg, var(--card), rgba(76, 175, 80, 0.15), var(--card));
            background-size: 300% 300%;
            animation: aurora-move 8s ease infinite;
            border: 1px solid var(--primary);
        }
        @keyframes aurora-move { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .effect-pulse {
            animation: pulse-red 4s infinite;
            border: 1px solid rgba(255, 59, 48, 0.3);
        }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.2); } 50% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

        /* HERO */
        .hero { text-align: center; padding-bottom: 15px; }
        .hero-time { background: rgba(128,128,128,0.1); color: var(--text); padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: inline-block; margin-bottom: 5px; }
        .hero-price { font-size: 72px; font-weight: 800; line-height: 1; letter-spacing: -2px; color: var(--primary); }
        .hero-unit { font-size: 16px; color: var(--muted); font-weight: 500; margin-top: 5px; }

        /* 24H KELL (CLOCK) */
        .clock-container { position: relative; width: 220px; height: 220px; margin: 0 auto; }
        #clock-canvas { width: 100%; height: 100%; transform: rotate(-90deg); /* 00:00 √ºles */ }
        .clock-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .clock-now-label { font-size: 12px; color: var(--muted); font-weight: 600; }
        .clock-now-val { font-size: 24px; font-weight: 800; color: var(--text); }

        /* TARK LAADIJA */
        .charger-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .slider-container { width: 100%; margin-bottom: 10px; }
        input[type=range] { width: 100%; accent-color: var(--primary); }
        .charge-result { background: rgba(76, 175, 80, 0.1); border-radius: 12px; padding: 15px; text-align: center; }
        .charge-time { font-size: 22px; font-weight: 800; color: var(--primary); display: block; margin-bottom: 5px; }
        .charge-saving { font-size: 13px; color: var(--muted); }

        /* GRAAFIK */
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .chart-box { height: 280px; width: 100%; position: relative; }
        .toggle-day { background: rgba(128,128,128,0.1); border: none; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text); cursor: pointer; }

        /* P√ÑIKE & ILM */
        .weather-grid { display: flex; gap: 10px; }
        .w-box { flex: 1; background: rgba(128,128,128,0.05); padding: 10px; border-radius: 12px; text-align: center; }
        .w-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .w-val { font-weight: 700; font-size: 14px; }
        .w-label { font-size: 11px; color: var(--muted); text-transform: uppercase; }

        /* S√ÑTTED MODAL */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999; align-items: flex-end; /* Sheet style */
        }
        .modal-content {
            background: var(--modal-bg); width: 100%; border-radius: 20px 20px 0 0;
            padding: 30px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .setting-input { width: 80px; padding: 8px; border-radius: 8px; border: 1px solid #ccc; text-align: center; font-size: 16px; background: var(--bg); color: var(--text); }
        .close-btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 15px; color: white; font-weight: 700; font-size: 16px; margin-top: 10px; }

        /* LISTID */
        .list-row { display: flex; gap: 15px; }
        .list-col { flex: 1; }
        .list-header { font-size: 12px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; color: var(--muted); }
        .item-row { display: flex; justify-content: space-between; font-size: 13px; padding: 8px 0; border-bottom: 1px solid var(--border); }
        
        h2 { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--muted); margin: 0 0 12px 0; letter-spacing: 0.8px; }
        .last-update { text-align: center; color: var(--muted); font-size: 10px; margin-top: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">

    <div class="app-header">
        <div class="app-title">‚ö°Ô∏è Nutikas Elekter</div>
        <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </div>

    <div class="card hero" id="hero-card">
        <div id="main-content">
            <div id="current-time" class="hero-time">--:--</div>
            <div id="current-price" class="hero-price">--</div>
            <div class="hero-unit">senti / kWh (KM <span id="vat-display">24</span>%)</div>
        </div>
    </div>

    <div class="card" style="text-align:center;">
        <h2>√ñ√∂p√§eva √ºlevaade</h2>
        <div class="clock-container">
            <canvas id="clock-canvas"></canvas>
            <div class="clock-center">
                <div class="clock-now-label">Hetkel</div>
                <div class="clock-now-val" id="clock-now-val">--</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>üöó Tark Laadija</h2>
        <div class="charger-row">
            <span>Laadimise aeg: <b id="charge-duration-lbl">4</b> tundi</span>
        </div>
        <div class="slider-container">
            <input type="range" min="1" max="12" value="4" id="charge-slider" oninput="calcSmartCharge()">
        </div>
        <div class="charge-result">
            <span class="charge-saving" id="charge-saving-text">Parim aeg alustamiseks:</span>
            <span class="charge-time" id="best-charge-time">--:--</span>
            <span class="charge-saving" id="charge-avg-price">--</span>
        </div>
    </div>

    <div class="card">
        <div class="chart-header">
            <h2>Hinnagraafik</h2>
            <select id="day-select" class="toggle-day" onchange="renderChart()">
                <option value="today">T√§na</option>
                <option value="tomorrow">Homme</option>
            </select>
        </div>
        <div class="chart-box">
            <canvas id="priceChart"></canvas>
            <div id="no-data-msg" class="hidden" style="position:absolute; top:40%; left:0; right:0; text-align:center; color:var(--muted);">
                Andmed puuduvad
            </div>
        </div>
    </div>

    <div class="card">
        <div class="list-row">
            <div class="list-col">
                <div class="list-header" style="color:var(--primary)">üü¢ SOODNE</div>
                <div id="list-cheap"></div>
            </div>
            <div class="list-col">
                <div class="list-header" style="color:var(--danger)">üî¥ KALLIS</div>
                <div id="list-expensive"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Ilm & P√§ike (V√µru)</h2>
        <div class="weather-grid">
            <div class="w-box">
                <span class="w-icon">üå°Ô∏è</span>
                <div class="w-val" id="w-temp">--¬∞</div>
                <div class="w-label">Temp</div>
            </div>
            <div class="w-box">
                <span class="w-icon">üí®</span>
                <div class="w-val" id="w-wind">-- m/s</div>
                <div class="w-label">Tuul</div>
            </div>
            <div class="w-box">
                <span class="w-icon" id="w-solar-icon">‚òÄÔ∏è</span>
                <div class="w-val" id="w-solar">--</div>
                <div class="w-label">P√§ike</div>
            </div>
        </div>
    </div>

    <div class="last-update" id="last-update-text"></div>
    <div style="text-align:center; color:var(--muted); font-size:11px; margin-top:5px; margin-bottom:20px;">
        v6.0 Robust
    </div>

</div>

<div id="settings-modal">
    <div class="modal-content">
        <h2 style="font-size:18px; margin-bottom:20px;">S√§tted</h2>
        
        <div class="setting-row">
            <span>Tume re≈æiim</span>
            <button class="toggle-day" onclick="toggleTheme()" id="theme-toggle-btn">Auto</button>
        </div>

        <div class="setting-row">
            <span>K√§ibemaks (%)</span>
            <input type="number" id="set-vat" class="setting-input" value="24">
        </div>

        <div class="setting-row">
            <span>Odava piir (s/kWh)</span>
            <input type="number" id="set-low" class="setting-input" value="5">
        </div>

        <div class="setting-row">
            <span>Kalli piir (s/kWh)</span>
            <input type="number" id="set-high" class="setting-input" value="15">
        </div>

        <button class="close-btn" onclick="saveSettings()">Salvesta ja Sulge</button>
    </div>
</div>

<script>
    // --- GLOBAL STATE ---
    let settings = {
        vat: 1.24,
        lowPrice: 5,
        highPrice: 15,
        theme: 'auto' 
    };

    let appData = { today: [], tomorrow: [], all: [] };
    let chartInstance = null;
    let clockInstance = null;
    let lastLoadedHour = -1;

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        loadSettings();
        applyTheme();
        loadCache();
        init();

        document.addEventListener("visibilitychange", () => { if (document.visibilityState === "visible") checkAndReload(); });
        setInterval(checkAndReload, 60000);
    });

    function checkAndReload() {
        const h = new Date().getHours();
        if (lastLoadedHour !== -1 && h !== lastLoadedHour) window.location.reload(); 
        else getElectricity();
    }

    async function init() {
        await Promise.all([getElectricity(), getWeather()]);
        lastLoadedHour = new Date().getHours();
        document.getElementById('last-update-text').innerText = "V√§rskendatud: " + new Date().toLocaleTimeString();
    }

    // --- DATA FETCHING (MULTI-PROXY) ---
    async function getElectricity() {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2).toISOString();
        const eleringUrl = `https://dashboard.elering.ee/api/nps/price?start=${start}&end=${end}`;

        // PROXY LIST (J√ÑRJEKORRAS)
        const proxies = [
            `https://corsproxy.io/?${encodeURIComponent(eleringUrl)}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(eleringUrl)}`,
            `https://thingproxy.freeboard.io/fetch/${eleringUrl}`
        ];

        let rawData = null;

        for (const proxy of proxies) {
            try {
                console.log("Trying proxy:", proxy);
                const r = await fetch(proxy);
                if (r.ok) {
                    const j = await r.json();
                    // AllOrigins tagastab m√µnikord andmed otse, m√µnikord 'contents' sees
                    if (j.data && j.data.ee) rawData = j.data.ee;
                    else if (j.contents) {
                        const parsed = JSON.parse(j.contents);
                        if (parsed.data && parsed.data.ee) rawData = parsed.data.ee;
                    }
                    else if (Array.isArray(j)) rawData = j; // M√µni API v√µib otse massiivi tagastada
                    
                    if (rawData) break; // √ïnnestus!
                }
            } catch (e) {
                console.warn("Proxy failed:", proxy, e);
            }
        }

        if (rawData) {
            processElectricity(rawData);
            localStorage.setItem('elekter_data', JSON.stringify(rawData));
        } else {
            console.error("All proxies failed.");
            // Kui vahem√§lu on t√ºhi, n√§ita viga
            if (appData.today.length === 0) {
                document.getElementById('current-price').innerText = "ERR";
                document.getElementById('current-price').style.color = "var(--danger)";
            }
        }
    }

    function loadCache() {
        const cached = localStorage.getItem('elekter_data');
        if(cached) {
            try {
                processElectricity(JSON.parse(cached));
            } catch(e) { console.log("Cache invalid"); }
        }
    }

    function processElectricity(data) {
        if (!data || !Array.isArray(data)) return;

        const todayStr = new Date().toDateString();
        const tmrwStr = new Date(new Date().setDate(new Date().getDate() + 1)).toDateString();

        appData.today = data.filter(d => new Date(d.timestamp*1000).toDateString() === todayStr);
        appData.tomorrow = data.filter(d => new Date(d.timestamp*1000).toDateString() === tmrwStr);
        appData.all = [...appData.today, ...appData.tomorrow]; 

        updateHero();
        renderClock();
        calcSmartCharge(); 
        renderChart();
        updateLists();
    }

    // --- LOGIC ---
    function updateHero() {
        const nowTs = Math.floor(Date.now()/1000/3600)*3600;
        const curr = appData.today.find(d => d.timestamp === nowTs);
        const card = document.getElementById('hero-card');
        const priceEl = document.getElementById('current-price');
        
        card.classList.remove('effect-aurora', 'effect-pulse');

        if(curr) {
            const price = (curr.price / 10 * settings.vat);
            priceEl.innerText = price.toFixed(2);
            document.getElementById('current-time').innerText = new Date().getHours() + ":00 ‚Äì " + (new Date().getHours()+1) + ":00";
            document.getElementById('clock-now-val').innerText = price.toFixed(1);

            if(price < settings.lowPrice) {
                card.classList.add('effect-aurora');
                priceEl.style.color = '#2E7D32'; 
            } else if (price > settings.highPrice) {
                card.classList.add('effect-pulse');
                priceEl.style.color = '#D32F2F'; 
            } else {
                priceEl.style.color = 'var(--text)';
            }
        }
    }

    // --- 24H KELL ---
    function renderClock() {
        const canvas = document.getElementById('clock-canvas');
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const size = 220;
        canvas.width = size * dpr; canvas.height = size * dpr;
        ctx.scale(dpr, dpr);

        const centerX = size/2; const centerY = size/2;
        const radius = size/2 - 10;
        const segmentAngle = (2 * Math.PI) / 24;

        ctx.clearRect(0, 0, size, size);

        appData.today.forEach(item => {
            const date = new Date(item.timestamp * 1000);
            const hour = date.getHours();
            const price = (item.price / 10 * settings.vat);
            
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, hour * segmentAngle, (hour + 1) * segmentAngle);
            ctx.closePath();

            if(price < settings.lowPrice) ctx.fillStyle = '#4CAF50';
            else if(price > settings.highPrice) ctx.fillStyle = '#FF3B30';
            else ctx.fillStyle = '#e0e0e0'; 
            
            if(hour === new Date().getHours()) {
                ctx.fillStyle = '#2196F3'; 
            }
            
            ctx.fill();
            ctx.strokeStyle = getComputedStyle(document.body).backgroundColor; 
            ctx.lineWidth = 2;
            ctx.stroke();
        });

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * 0.6, 0, 2 * Math.PI);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card');
        ctx.fill();
    }

    // --- SMART CHARGE ---
    function calcSmartCharge() {
        const duration = parseInt(document.getElementById('charge-slider').value);
        document.getElementById('charge-duration-lbl').innerText = duration;

        const nowTs = Math.floor(Date.now()/1000/3600)*3600;
        const futureData = appData.all.filter(d => d.timestamp >= nowTs);

        if(futureData.length < duration) {
            document.getElementById('best-charge-time').innerText = "Andmed puuduvad";
            return;
        }

        let bestAvg = Infinity;
        let bestStartItem = null;

        for(let i=0; i <= futureData.length - duration; i++) {
            let sum = 0;
            for(let j=0; j<duration; j++) sum += futureData[i+j].price;
            let avg = sum / duration;
            if(avg < bestAvg) { bestAvg = avg; bestStartItem = futureData[i]; }
        }

        if(bestStartItem) {
            const d = new Date(bestStartItem.timestamp * 1000);
            const price = (bestAvg / 10 * settings.vat).toFixed(2);
            let dayText = d.getDate() !== new Date().getDate() ? "Homme" : "T√§na";
            document.getElementById('best-charge-time').innerText = `${dayText} kell ${d.getHours()}:00`;
            document.getElementById('charge-avg-price').innerText = `Keskmine hind: ${price} s/kWh`;
        }
    }

    // --- ILM & P√ÑIKE ---
    async function getWeather() {
        try {
            const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=57.848&longitude=27.014&current=temperature_2m,wind_speed_10m,cloud_cover,is_day");
            const j = await r.json();
            const curr = j.current;
            
            document.getElementById('w-temp').innerText = Math.round(curr.temperature_2m) + "¬∞";
            document.getElementById('w-wind').innerText = Math.round(curr.wind_speed_10m / 3.6) + " m/s";

            let solarText = "Madal";
            let solarIcon = "‚òÅÔ∏è";
            if (curr.is_day === 1) {
                if (curr.cloud_cover < 30) { solarText = "K√µrge!"; solarIcon = "‚òÄÔ∏è"; }
                else if (curr.cloud_cover < 70) { solarText = "Keskmine"; solarIcon = "‚õÖ"; }
            } else { solarText = "√ñ√∂"; solarIcon = "üåô"; }
            
            document.getElementById('w-solar').innerText = solarText;
            document.getElementById('w-solar-icon').innerText = solarIcon;
        } catch(e) {}
    }

    // --- GRAAFIK ---
    function renderChart() {
        const mode = document.getElementById('day-select').value;
        let data = mode === 'today' ? appData.today : appData.tomorrow;
        
        if (mode === 'today') {
            const currentH = new Date().getHours();
            data = data.filter(d => new Date(d.timestamp * 1000).getHours() >= currentH);
        }

        if(!data.length) {
            document.getElementById('priceChart').style.display = 'none';
            document.getElementById('no-data-msg').classList.remove('hidden');
            return;
        } else {
            document.getElementById('priceChart').style.display = 'block';
            document.getElementById('no-data-msg').classList.add('hidden');
        }

        const ctx = document.getElementById('priceChart').getContext('2d');
        const labels = data.map(d => new Date(d.timestamp*1000).getHours());
        const values = data.map(d => parseFloat((d.price/10*settings.vat).toFixed(2)));
        
        if(chartInstance) chartInstance.destroy();

        const segmentColor = ctx => {
            const v = ctx.p0.parsed.y;
            if(v < settings.lowPrice) return '#4CAF50';
            if(v > settings.highPrice) return '#FF3B30';
            return '#FF9500';
        };

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(76, 175, 80, 0.2)');
        gradient.addColorStop(1, 'rgba(76, 175, 80, 0.0)');

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hind',
                    data: values,
                    borderWidth: 3,
                    stepped: true,
                    fill: true,
                    backgroundColor: gradient,
                    segment: { borderColor: ctx => segmentColor(ctx) },
                    pointRadius: (ctx) => (ctx.dataIndex === 0) ? 6 : 0, 
                    pointBackgroundColor: '#4CAF50',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Hind: ${c.raw} s` } } },
                scales: {
                    x: { grid: { display:false }, ticks: { maxTicksLimit: 8, autoSkip: true, maxRotation: 0 } },
                    y: { beginAtZero: true, grid: { color: getComputedStyle(document.body).getPropertyValue('--chart-grid') } }
                }
            }
        });
        updateLists();
    }

    function updateLists() {
        const data = appData.today;
        if(!data.length) return;
        const sorted = [...data].sort((a,b) => a.price - b.price);
        
        const render = (arr, elId, color) => {
            document.getElementById(elId).innerHTML = arr.map(i => {
                const p = (i.price/10*settings.vat).toFixed(1);
                const h = new Date(i.timestamp*1000).getHours().toString().padStart(2,'0');
                return `<div class="item-row"><span>${h}:00</span><span style="color:${color}; font-weight:700;">${p} s</span></div>`;
            }).join('');
        };
        render(sorted.slice(0,3), 'list-cheap', 'var(--primary)');
        render(sorted.slice(-3).reverse(), 'list-expensive', 'var(--danger)');
    }

    // --- SETTINGS ---
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function saveSettings() {
        settings.vat = parseFloat(document.getElementById('set-vat').value) / 100 + 1;
        settings.lowPrice = parseFloat(document.getElementById('set-low').value);
        settings.highPrice = parseFloat(document.getElementById('set-high').value);
        localStorage.setItem('user_settings', JSON.stringify(settings));
        document.getElementById('settings-modal').style.display = 'none';
        document.getElementById('vat-display').innerText = document.getElementById('set-vat').value;
        updateHero(); renderClock(); renderChart(); calcSmartCharge(); updateLists();
    }

    function loadSettings() {
        const saved = localStorage.getItem('user_settings');
        if(saved) {
            const s = JSON.parse(saved);
            document.getElementById('set-vat').value = Math.round((s.vat - 1) * 100);
            document.getElementById('set-low').value = s.lowPrice;
            document.getElementById('set-high').value = s.highPrice;
            document.getElementById('vat-display').innerText = document.getElementById('set-vat').value;
            settings = s;
            if(settings.theme) applyTheme(settings.theme);
        }
    }

    function toggleTheme() {
        if(settings.theme === 'auto') settings.theme = 'dark';
        else if(settings.theme === 'dark') settings.theme = 'light';
        else settings.theme = 'auto';
        applyTheme();
    }

    function applyTheme() {
        const btn = document.getElementById('theme-toggle-btn');
        const root = document.documentElement;
        if (settings.theme === 'auto') {
            btn.innerText = "Auto";
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) root.setAttribute('data-theme', 'dark');
            else root.removeAttribute('data-theme');
        } else if (settings.theme === 'dark') {
            btn.innerText = "Tume";
            root.setAttribute('data-theme', 'dark');
        } else {
            btn.innerText = "Hele";
            root.removeAttribute('data-theme');
        }
    }
</script>
</body>
</html>
